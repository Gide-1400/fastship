<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إنشاء شحنة جديدة | FastShip</title>
    <link rel="stylesheet" href="../css/global.css">
    <link rel="stylesheet" href="../css/animations.css">
    <style>
        .page-container {
            max-width: 800px;
            margin: 40px auto;
            padding: 0 20px;
        }

        .page-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        .page-header h1 {
            color: white;
            margin: 0 0 10px;
            font-size: 32px;
        }

        .page-header p {
            margin: 0;
            opacity: 0.9;
        }

        .form-card {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .form-section {
            margin-bottom: 35px;
            padding-bottom: 35px;
            border-bottom: 1px solid #f0f0f0;
        }

        .form-section:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .form-section h3 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .form-row.single {
            grid-template-columns: 1fr;
        }

        .cities-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            padding: 10px;
            margin-top: 10px;
            display: none;
        }

        .city-option {
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 5px;
            transition: all 0.2s;
        }

        .city-option:hover {
            background: #f5f5ff;
            color: #667eea;
        }

        .price-estimate {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            text-align: center;
        }

        .price-value {
            font-size: 36px;
            font-weight: bold;
            color: #667eea;
            margin: 10px 0;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .action-buttons button {
            flex: 1;
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: #667eea;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .back-link:hover {
            color: #764ba2;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }

            .page-header h1 {
                font-size: 24px;
            }

            .form-card {
                padding: 25px;
            }
        }
    </style>
</head>
<body>
    <div class="page-container">
        <a href="dashboard.html" class="back-link">
            <span>←</span>
            <span>العودة للوحة التحكم</span>
        </a>

        <div class="page-header animate-fadeInDown">
            <h1>📦 إنشاء شحنة جديدة</h1>
            <p>املأ البيانات التالية لإنشاء طلب شحن</p>
        </div>

        <div class="form-card animate-fadeInUp">
            <form id="shipmentForm">
                <!-- معلومات الشحنة -->
                <div class="form-section">
                    <h3>
                        <span>📋</span>
                        <span>معلومات الشحنة</span>
                    </h3>
                    <div class="form-group">
                        <label for="itemType">نوع البضاعة *</label>
                        <select id="itemType" class="form-control" required>
                            <option value="">اختر نوع البضاعة</option>
                            <option value="documents">مستندات</option>
                            <option value="electronics">إلكترونيات</option>
                            <option value="clothing">ملابس</option>
                            <option value="furniture">أثاث</option>
                            <option value="food">مواد غذائية</option>
                            <option value="other">أخرى</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="weight">الوزن (كجم) *</label>
                            <input type="number" id="weight" class="form-control" 
                                   placeholder="مثال: 15" min="0.1" step="0.1" required>
                        </div>
                        <div class="form-group">
                            <label for="size">الحجم *</label>
                            <select id="size" class="form-control" required>
                                <option value="">اختر الحجم</option>
                                <option value="small">صغير (أقل من 30 سم)</option>
                                <option value="medium">متوسط (30-60 سم)</option>
                                <option value="large">كبير (60-100 سم)</option>
                                <option value="xlarge">كبير جداً (أكثر من 100 سم)</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="description">وصف البضاعة</label>
                        <textarea id="description" class="form-control" rows="3" 
                                  placeholder="اكتب وصفاً مختصراً للبضاعة..."></textarea>
                    </div>
                </div>

                <!-- المسار -->
                <div class="form-section">
                    <h3>
                        <span>🗺️</span>
                        <span>المسار</span>
                    </h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="fromCity">من (المدينة) *</label>
                            <input type="text" id="fromCity" class="form-control" 
                                   placeholder="مثال: الرياض" required autocomplete="off">
                        </div>
                        <div class="form-group">
                            <label for="toCity">إلى (المدينة) *</label>
                            <input type="text" id="toCity" class="form-control" 
                                   placeholder="مثال: جدة" required autocomplete="off">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="pickupAddress">عنوان الاستلام *</label>
                            <input type="text" id="pickupAddress" class="form-control" 
                                   placeholder="العنوان التفصيلي" required>
                        </div>
                        <div class="form-group">
                            <label for="deliveryAddress">عنوان التسليم *</label>
                            <input type="text" id="deliveryAddress" class="form-control" 
                                   placeholder="العنوان التفصيلي" required>
                        </div>
                    </div>
                </div>

                <!-- التوقيت -->
                <div class="form-section">
                    <h3>
                        <span>⏰</span>
                        <span>التوقيت</span>
                    </h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="pickupDate">تاريخ الاستلام المفضل *</label>
                            <input type="date" id="pickupDate" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="deliveryDate">تاريخ التسليم المطلوب *</label>
                            <input type="date" id="deliveryDate" class="form-control" required>
                        </div>
                    </div>
                </div>

                <!-- معلومات الاتصال -->
                <div class="form-section">
                    <h3>
                        <span>📞</span>
                        <span>معلومات الاتصال</span>
                    </h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="senderPhone">رقم المرسل *</label>
                            <input type="tel" id="senderPhone" class="form-control" 
                                   placeholder="+966 5xxxxxxxx" required>
                        </div>
                        <div class="form-group">
                            <label for="receiverPhone">رقم المستلم *</label>
                            <input type="tel" id="receiverPhone" class="form-control" 
                                   placeholder="+966 5xxxxxxxx" required>
                        </div>
                    </div>
                </div>

                <!-- السعر المتوقع -->
                <div class="price-estimate">
                    <div style="color: #666; margin-bottom: 5px;">السعر المقدر</div>
                    <div class="price-value" id="estimatedPrice">-</div>
                    <div style="color: #999; font-size: 14px;">
                        * السعر النهائي يتم الاتفاق عليه مع الموصل
                    </div>
                </div>

                <!-- الأزرار -->
                <div class="action-buttons">
                    <button type="button" class="btn btn-secondary" onclick="history.back()">
                        إلغاء
                    </button>
                    <button type="submit" class="btn btn-primary" id="submitBtn">
                        إنشاء الشحنة
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script type="module" src="../js/firebase-config.js"></script>
    <script src="../js/utils.js"></script>
    <script type="module" src="../js/database.js"></script>
    <script type="module" src="../js/matching.js"></script>

    <script type="module">
        import { createShipment } from '../js/database.js';

        // التحقق من تسجيل الدخول
        const user = window.utils.getFromStorage('fastship_user');
        if (!user || user.userType !== 'shipper') {
            window.location.href = '../shared-auth.html';
        }

        // تعيين الحد الأدنى للتاريخ (اليوم)
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('pickupDate').min = today;
        document.getElementById('deliveryDate').min = today;

        // حساب السعر التقديري
        function calculateEstimate() {
            const weight = parseFloat(document.getElementById('weight').value) || 0;
            const from = document.getElementById('fromCity').value;
            const to = document.getElementById('toCity').value;

            if (weight > 0 && from && to) {
                // حساب بسيط: وزن × 2 + مسافة افتراضية
                const basePrice = weight * 2;
                const distanceEstimate = 300; // افتراضي
                const estimated = Math.round(basePrice + distanceEstimate);
                
                document.getElementById('estimatedPrice').textContent = 
                    window.utils.formatCurrency(estimated);
            }
        }

        // الاستماع للتغييرات
        document.getElementById('weight').addEventListener('input', calculateEstimate);
        document.getElementById('fromCity').addEventListener('change', calculateEstimate);
        document.getElementById('toCity').addEventListener('change', calculateEstimate);

        // إرسال النموذج
        document.getElementById('shipmentForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const btn = document.getElementById('submitBtn');
            const originalText = btn.textContent;

            try {
                btn.disabled = true;
                btn.textContent = 'جاري الإنشاء...';

                const shipmentData = {
                    itemType: document.getElementById('itemType').value,
                    weight: parseFloat(document.getElementById('weight').value),
                    size: document.getElementById('size').value,
                    description: document.getElementById('description').value,
                    from: document.getElementById('fromCity').value,
                    to: document.getElementById('toCity').value,
                    pickupAddress: document.getElementById('pickupAddress').value,
                    deliveryAddress: document.getElementById('deliveryAddress').value,
                    pickupDate: document.getElementById('pickupDate').value,
                    deliveryDate: document.getElementById('deliveryDate').value,
                    senderPhone: document.getElementById('senderPhone').value,
                    receiverPhone: document.getElementById('receiverPhone').value,
                    estimatedPrice: document.getElementById('estimatedPrice').textContent
                };

                const result = await createShipment(user.userId, shipmentData);

                if (result.success) {
                    window.utils.showNotification('✅ تم إنشاء الشحنة بنجاح!', 'success');
                    setTimeout(() => {
                        window.location.href = 'my-shipments.html';
                    }, 1500);
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('Error creating shipment:', error);
                window.utils.showNotification('❌ حدث خطأ في إنشاء الشحنة', 'error');
                btn.disabled = false;
                btn.textContent = originalText;
            }
        });
    </script>
</body>
</html>