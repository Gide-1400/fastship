<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ù†Ø´Ø§Ø¡ Ø´Ø­Ù†Ø© Ø¬Ø¯ÙŠØ¯Ø© | FastShip</title>
    <link rel="stylesheet" href="../css/global.css">
    <link rel="stylesheet" href="../css/animations.css">
    <style>
        .page-container {
            max-width: 800px;
            margin: 40px auto;
            padding: 0 20px;
        }

        .page-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        .page-header h1 {
            color: white;
            margin: 0 0 10px;
            font-size: 32px;
        }

        .page-header p {
            margin: 0;
            opacity: 0.9;
        }

        .form-card {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .form-section {
            margin-bottom: 35px;
            padding-bottom: 35px;
            border-bottom: 1px solid #f0f0f0;
        }

        .form-section:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .form-section h3 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .form-row.single {
            grid-template-columns: 1fr;
        }

        .cities-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            padding: 10px;
            margin-top: 10px;
            display: none;
        }

        .city-option {
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 5px;
            transition: all 0.2s;
        }

        .city-option:hover {
            background: #f5f5ff;
            color: #667eea;
        }

        .price-estimate {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            text-align: center;
        }

        .price-value {
            font-size: 36px;
            font-weight: bold;
            color: #667eea;
            margin: 10px 0;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .action-buttons button {
            flex: 1;
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: #667eea;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .back-link:hover {
            color: #764ba2;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }

            .page-header h1 {
                font-size: 24px;
            }

            .form-card {
                padding: 25px;
            }
        }
    </style>
</head>
<body>
    <div class="page-container">
        <a href="dashboard.html" class="back-link">
            <span>â†</span>
            <span>Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</span>
        </a>

        <div class="page-header animate-fadeInDown">
            <h1>ğŸ“¦ Ø¥Ù†Ø´Ø§Ø¡ Ø´Ø­Ù†Ø© Ø¬Ø¯ÙŠØ¯Ø©</h1>
            <p>Ø§Ù…Ù„Ø£ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ Ø´Ø­Ù†</p>
        </div>

        <div class="form-card animate-fadeInUp">
            <form id="shipmentForm">
                <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø´Ø­Ù†Ø© -->
                <div class="form-section">
                    <h3>
                        <span>ğŸ“‹</span>
                        <span>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø´Ø­Ù†Ø©</span>
                    </h3>
                    <div class="form-group">
                        <label for="itemType">Ù†ÙˆØ¹ Ø§Ù„Ø¨Ø¶Ø§Ø¹Ø© *</label>
                        <select id="itemType" class="form-control" required>
                            <option value="">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¨Ø¶Ø§Ø¹Ø©</option>
                            <option value="documents">Ù…Ø³ØªÙ†Ø¯Ø§Øª</option>
                            <option value="electronics">Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ§Øª</option>
                            <option value="clothing">Ù…Ù„Ø§Ø¨Ø³</option>
                            <option value="furniture">Ø£Ø«Ø§Ø«</option>
                            <option value="food">Ù…ÙˆØ§Ø¯ ØºØ°Ø§Ø¦ÙŠØ©</option>
                            <option value="other">Ø£Ø®Ø±Ù‰</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="weight">Ø§Ù„ÙˆØ²Ù† (ÙƒØ¬Ù…) *</label>
                            <input type="number" id="weight" class="form-control" 
                                   placeholder="Ù…Ø«Ø§Ù„: 15" min="0.1" step="0.1" required>
                        </div>
                        <div class="form-group">
                            <label for="size">Ø§Ù„Ø­Ø¬Ù… *</label>
                            <select id="size" class="form-control" required>
                                <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø­Ø¬Ù…</option>
                                <option value="small">ØµØºÙŠØ± (Ø£Ù‚Ù„ Ù…Ù† 30 Ø³Ù…)</option>
                                <option value="medium">Ù…ØªÙˆØ³Ø· (30-60 Ø³Ù…)</option>
                                <option value="large">ÙƒØ¨ÙŠØ± (60-100 Ø³Ù…)</option>
                                <option value="xlarge">ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹ (Ø£ÙƒØ«Ø± Ù…Ù† 100 Ø³Ù…)</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="description">ÙˆØµÙ Ø§Ù„Ø¨Ø¶Ø§Ø¹Ø©</label>
                        <textarea id="description" class="form-control" rows="3" 
                                  placeholder="Ø§ÙƒØªØ¨ ÙˆØµÙØ§Ù‹ Ù…Ø®ØªØµØ±Ø§Ù‹ Ù„Ù„Ø¨Ø¶Ø§Ø¹Ø©..."></textarea>
                    </div>
                </div>

                <!-- Ø§Ù„Ù…Ø³Ø§Ø± -->
                <div class="form-section">
                    <h3>
                        <span>ğŸ—ºï¸</span>
                        <span>Ø§Ù„Ù…Ø³Ø§Ø±</span>
                    </h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="fromCity">Ù…Ù† (Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©) *</label>
                            <input type="text" id="fromCity" class="form-control" 
                                   placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ø±ÙŠØ§Ø¶" required autocomplete="off">
                        </div>
                        <div class="form-group">
                            <label for="toCity">Ø¥Ù„Ù‰ (Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©) *</label>
                            <input type="text" id="toCity" class="form-control" 
                                   placeholder="Ù…Ø«Ø§Ù„: Ø¬Ø¯Ø©" required autocomplete="off">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="pickupAddress">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… *</label>
                            <input type="text" id="pickupAddress" class="form-control" 
                                   placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªÙØµÙŠÙ„ÙŠ" required>
                        </div>
                        <div class="form-group">
                            <label for="deliveryAddress">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªØ³Ù„ÙŠÙ… *</label>
                            <input type="text" id="deliveryAddress" class="form-control" 
                                   placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªÙØµÙŠÙ„ÙŠ" required>
                        </div>
                    </div>
                </div>

                <!-- Ø§Ù„ØªÙˆÙ‚ÙŠØª -->
                <div class="form-section">
                    <h3>
                        <span>â°</span>
                        <span>Ø§Ù„ØªÙˆÙ‚ÙŠØª</span>
                    </h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="pickupDate">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ù…ÙØ¶Ù„ *</label>
                            <input type="date" id="pickupDate" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="deliveryDate">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ù„ÙŠÙ… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ *</label>
                            <input type="date" id="deliveryDate" class="form-control" required>
                        </div>
                    </div>
                </div>

                <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„ -->
                <div class="form-section">
                    <h3>
                        <span>ğŸ“</span>
                        <span>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„</span>
                    </h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="senderPhone">Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø³Ù„ *</label>
                            <input type="tel" id="senderPhone" class="form-control" 
                                   placeholder="+966 5xxxxxxxx" required>
                        </div>
                        <div class="form-group">
                            <label for="receiverPhone">Ø±Ù‚Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù… *</label>
                            <input type="tel" id="receiverPhone" class="form-control" 
                                   placeholder="+966 5xxxxxxxx" required>
                        </div>
                    </div>
                </div>

                <!-- Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ -->
                <div class="price-estimate">
                    <div style="color: #666; margin-bottom: 5px;">Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ù‚Ø¯Ø±</div>
                    <div class="price-value" id="estimatedPrice">-</div>
                    <div style="color: #999; font-size: 14px;">
                        * Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ ÙŠØªÙ… Ø§Ù„Ø§ØªÙØ§Ù‚ Ø¹Ù„ÙŠÙ‡ Ù…Ø¹ Ø§Ù„Ù…ÙˆØµÙ„
                    </div>
                </div>

                <!-- Ø§Ù„Ø£Ø²Ø±Ø§Ø± -->
                <div class="action-buttons">
                    <button type="button" class="btn btn-secondary" onclick="history.back()">
                        Ø¥Ù„ØºØ§Ø¡
                    </button>
                    <button type="submit" class="btn btn-primary" id="submitBtn">
                        Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø´Ø­Ù†Ø©
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script type="module" src="../js/firebase-config.js"></script>
    <script src="../js/utils.js"></script>
    <script type="module" src="../js/database.js"></script>
    <script type="module" src="../js/matching.js"></script>

    <script type="module">
        import { createShipment } from '../js/database.js';

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        const user = window.utils.getFromStorage('fastship_user');
        if (!user || user.userType !== 'shipper') {
            window.location.href = '../shared-auth.html';
        }

        // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„ØªØ§Ø±ÙŠØ® (Ø§Ù„ÙŠÙˆÙ…)
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('pickupDate').min = today;
        document.getElementById('deliveryDate').min = today;

        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠ
        function calculateEstimate() {
            const weight = parseFloat(document.getElementById('weight').value) || 0;
            const from = document.getElementById('fromCity').value;
            const to = document.getElementById('toCity').value;

            if (weight > 0 && from && to) {
                // Ø­Ø³Ø§Ø¨ Ø¨Ø³ÙŠØ·: ÙˆØ²Ù† Ã— 2 + Ù…Ø³Ø§ÙØ© Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
                const basePrice = weight * 2;
                const distanceEstimate = 300; // Ø§ÙØªØ±Ø§Ø¶ÙŠ
                const estimated = Math.round(basePrice + distanceEstimate);
                
                document.getElementById('estimatedPrice').textContent = 
                    window.utils.formatCurrency(estimated);
            }
        }

        // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„ØªØºÙŠÙŠØ±Ø§Øª
        document.getElementById('weight').addEventListener('input', calculateEstimate);
        document.getElementById('fromCity').addEventListener('change', calculateEstimate);
        document.getElementById('toCity').addEventListener('change', calculateEstimate);

        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
        document.getElementById('shipmentForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const btn = document.getElementById('submitBtn');
            const originalText = btn.textContent;

            try {
                btn.disabled = true;
                btn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡...';

                const shipmentData = {
                    itemType: document.getElementById('itemType').value,
                    weight: parseFloat(document.getElementById('weight').value),
                    size: document.getElementById('size').value,
                    description: document.getElementById('description').value,
                    from: document.getElementById('fromCity').value,
                    to: document.getElementById('toCity').value,
                    pickupAddress: document.getElementById('pickupAddress').value,
                    deliveryAddress: document.getElementById('deliveryAddress').value,
                    pickupDate: document.getElementById('pickupDate').value,
                    deliveryDate: document.getElementById('deliveryDate').value,
                    senderPhone: document.getElementById('senderPhone').value,
                    receiverPhone: document.getElementById('receiverPhone').value,
                    estimatedPrice: document.getElementById('estimatedPrice').textContent
                };

                const result = await createShipment(user.userId, shipmentData);

                if (result.success) {
                    window.utils.showNotification('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø´Ø­Ù†Ø© Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                    setTimeout(() => {
                        window.location.href = 'my-shipments.html';
                    }, 1500);
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('Error creating shipment:', error);
                window.utils.showNotification('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø´Ø­Ù†Ø©', 'error');
                btn.disabled = false;
                btn.textContent = originalText;
            }
        });
    </script>
</body>
</html>